WITH date_range AS (
  SELECT DISTINCT FISC_YR_START_DATE, DATE_TRUNC('month', CURRENT_DATE) - INTERVAL '1 day' AS PREV_MTH_END_DATE
  FROM idpdm.MD_TIME_FDIM
  WHERE DAY_DATE = CURRENT_DATE
)

SELECT *
FROM idpdm.apo_frcst_wk_fct
WHERE FRCST_VERS_DATE IN (SELECT DAY_NUM
FROM idpdm.MD_TIME_FDIM
WHERE DAY_DATE BETWEEN (SELECT FISC_YR_START_DATE FROM date_range) AND (SELECT PREV_MTH_END_DATE FROM date_range)) 
AND TP_END_DATE <= DATE_FORMAT(DATE_ADD(CURRENT_DATE(), 365), 'yyyyMMdd')
AND FILE_SUB_REGN_NAME = 'EU'
AND ORG_CODE = 'R'
AND PROD_ID IN (
    SELECT DISTINCT PROD_ID 
    FROM idpdm.MD_PROD_9005_DAY_FDIM
    WHERE PROD_4_NAME IN ('AIR','CLEANPROD','CLEANSYS','AUTODISH','HANDDISH')
);
