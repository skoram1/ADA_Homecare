WITH date_range AS (
  SELECT DISTINCT 
    FISC_YR_START_DATE - INTERVAL '1 YEAR' AS START_DATE, 
    FISC_YR_END_DATE - INTERVAL '1 YEAR' AS END_DATE,
    FISC_YR_START_DATE - INTERVAL '2 YEAR' AS START_DATE2, 
    FISC_YR_END_DATE - INTERVAL '2 YEAR' AS END_DATE2
  FROM idpdm.MD_TIME_FDIM
  WHERE DAY_DATE = CURRENT_DATE
)

SELECT *
FROM idpdm.apo_frcst_wk_fct
WHERE FRCST_VERS_DATE IN (
    SELECT DAY_NUM
    FROM idpdm.MD_TIME_FDIM
    WHERE (DAY_DATE BETWEEN (SELECT START_DATE FROM date_range) AND (SELECT END_DATE FROM date_range)
        OR DAY_DATE BETWEEN (SELECT START_DATE2 FROM date_range) AND (SELECT END_DATE2 FROM date_range))
        AND DAY_OF_WK_NAME = 'MONDAY' 
        AND SOP_FLAG = 'Y' 
    LIMIT 1
) 
AND TP_END_DATE <= DATE_FORMAT(DATE_ADD(CURRENT_DATE(), 365), 'yyyyMMdd')
AND FILE_SUB_REGN_NAME = 'EU'
AND ORG_CODE = 'R'
AND PROD_ID IN (
    SELECT DISTINCT PROD_ID 
    FROM idpdm.MD_PROD_9005_DAY_FDIM
    WHERE PROD_4_NAME IN ('AIR','CLEANPROD','CLEANSYS','AUTODISH','HANDDISH')
)
